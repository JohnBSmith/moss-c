
begin
public new_gauss, gauss, gauss_legendre, legendre_table
use sf: PP
use libinv: zeroes

GL32 = [
  [-0.9972638618494816, 0.007018610009470141],
  [-0.9856115115452684, 0.01627439473090563],
  [-0.9647622555875064, 0.02539206530926208],
  [-0.9349060759377397, 0.03427386291302148],
  [-0.8963211557660522, 0.04283589802222668],
  [-0.8493676137325699, 0.05099805926237622],
  [-0.7944837959679425, 0.05868409347853551],
  [-0.7321821187402897, 0.06582222277636184],
  [-0.6630442669302152, 0.07234579410884850],
  [-0.5877157572407623, 0.07819389578707028],
  [-0.5068999089322295, 0.08331192422694673],
  [-0.4213512761306354, 0.08765209300440380],
  [-0.3318686022821277, 0.09117387869576390],
  [-0.2392873622521371, 0.09384439908080457],
  [-0.1444719615827965, 0.09563872007927489],
  [-0.04830766568773831,0.09654008851472778],
  [ 0.04830766568773831,0.09654008851472778],
  [ 0.1444719615827965, 0.09563872007927489],
  [ 0.2392873622521371, 0.09384439908080457],
  [ 0.3318686022821277, 0.09117387869576390],
  [ 0.4213512761306354, 0.08765209300440380],
  [ 0.5068999089322295, 0.08331192422694673],
  [ 0.5877157572407623, 0.07819389578707028],
  [ 0.6630442669302152, 0.07234579410884850],
  [ 0.7321821187402897, 0.06582222277636184],
  [ 0.7944837959679425, 0.05868409347853551],
  [ 0.8493676137325699, 0.05099805926237622],
  [ 0.8963211557660522, 0.04283589802222668],
  [ 0.9349060759377397, 0.03427386291302148],
  [ 0.9647622555875064, 0.02539206530926208],
  [ 0.9856115115452684, 0.01627439473090563],
  [ 0.9972638618494816, 0.007018610009470141]
]

DPP = |n,x| n*(x*PP(n,x)-PP(n-1,x))/(x^2-1)
weight = |n,x| 2/((1-x^2)*DPP(n,x)^2)

function legendre_table(n)
  h = (1E-3 if n<=40
    else 1E-4 if n<=300
    else 1E-5 if n<=1200
    else 1E-6)
  L = zeroes(|x| PP(n,x),-1,1,h)
  return L.map(|x| [x,weight(n,x)])
end

sub legendre_table_string(n)
  L = legendre_table(n)
  a = []
  for t in L
    a.push("[{G18}, {G18}]" % t)
  end
  return ["[", a.join("\n,"), "]"].join()
end
legendre_table.str = legendre_table_string

function new_gauss(t)
  N = size(t)
  return fn integral|a,b,f,n=2|
    s=0; h = (b-a)/n
    for j in n
      aj = a+j*h
      bj = a+(j+1)*h
      p = 0.5*(bj-aj)
      q = 0.5*(aj+bj)
      sj = 0
      for i in N
        sj += t[i][1]*f(p*t[i][0]+q)
      end
      s += p*sj
    end
    return s
  end
end

gauss = new_gauss(GL32)

function gauss_legendre(n)
  return new_gauss(legendre_table(n))
end


end


